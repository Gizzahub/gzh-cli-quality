name: Test Coverage

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run tests with coverage
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out -o coverage.txt

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Current coverage: $COVERAGE%"

          # Minimum threshold: 40%
          if (( $(echo "$COVERAGE < 40.0" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below minimum threshold of 40%"
            exit 1
          fi

          echo "âœ… Coverage $COVERAGE% meets minimum threshold"

          # Recommended threshold: 50%
          if (( $(echo "$COVERAGE >= 50.0" | bc -l) )); then
            echo "ðŸŽ‰ Coverage $COVERAGE% exceeds recommended threshold of 50%"
          fi

      - name: Generate coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html
            coverage.txt
          retention-days: 30

      - name: Generate coverage summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | tail -1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage by Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | grep -E "github.com/Gizzahub/gzh-cli-quality/(config|detector|executor|git|report|tools)/" | awk '{print $1 "\t" $3}' | sed 's/github.com\/Gizzahub\/gzh-cli-quality\///' | sort -t/ -k1,1 -k2 | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage.txt', 'utf8');
            const lines = coverage.split('\n');

            // Extract total coverage
            const totalLine = lines[lines.length - 2] || lines[lines.length - 1];
            const match = totalLine.match(/(\d+\.\d+)%/);
            const totalCoverage = match ? match[1] : 'N/A';

            // Determine status emoji
            let statusEmoji = 'âœ…';
            let statusText = 'meets minimum threshold (40%)';
            if (parseFloat(totalCoverage) < 40.0) {
              statusEmoji = 'âŒ';
              statusText = '**is below minimum threshold (40%)**';
            } else if (parseFloat(totalCoverage) >= 50.0) {
              statusEmoji = 'ðŸŽ‰';
              statusText = 'exceeds recommended threshold (50%)';
            }

            let body = `## ${statusEmoji} Test Coverage Report\n\n`;
            body += `**Total Coverage:** ${totalCoverage}% ${statusText}\n\n`;
            body += '### Coverage by Package\n\n';
            body += '```\n';

            // Extract package coverage (last 15 lines before total)
            const packageLines = lines.slice(-25, -2).filter(line =>
              line.includes('github.com/Gizzahub/gzh-cli-quality/')
            );

            packageLines.forEach(line => {
              const simplified = line.replace('github.com/Gizzahub/gzh-cli-quality/', '');
              body += simplified + '\n';
            });

            body += '```\n\n';
            body += 'ðŸ“¥ [Download detailed coverage report](../actions/runs/' + context.runId + ')\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
